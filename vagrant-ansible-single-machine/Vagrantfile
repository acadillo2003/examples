# -*- mode: ruby -*-
# vim: ft=ruby


# ---- Configuration variables ----

GUI               = false # Enable/Disable GUI
RAM               = 128   # Default memory size in MB

# Network configuration
DOMAIN            = ".nat.example.com"
NETWORK           = "192.168.50."
NETMASK           = "255.255.255.0"

# Default Virtualbox .box
# Source: https://github.com/ginas/vagrant-debian-wheezy-64
BOX               = 'debian-wheezy-amd64-netinst'
BOX_URL           = 'https://dl.dropboxusercontent.com/u/55426468/20140317/debian-wheezy-amd64-netinst.box'

# Ansible configuration
ANSIBLE_INVENTORY = "my-static-vagrant-inventory"
ANSIBLE_PLAYBOOK  = "site.yml"

# Inventory parts to by symlinked into auto-generated inventory
INVENTORY_PARTS = ['host_vars', 'group_vars']


# ---- Custom commands run on the main host ----

# Symlink inventory parts into inventory auto-generated by Vagrant
require 'pathname'
aiv = Pathname.new('ansible/inventory')
viv = Pathname.new('.vagrant/provisioners/ansible/inventory')
viv.mkpath()
for name in INVENTORY_PARTS do
  target = viv+name
  target.make_symlink((aiv+name).relative_path_from(viv)) unless target.exist?
end

# ---- Vagrant configuration ----

Vagrant.configure(2) do |config|

  config.vm.box     = BOX
  config.vm.box_url = BOX_URL

  config.vm.guest = :debian

  config.vm.provider "virtualbox" do |vbox|
    vbox.gui    = GUI
    vbox.memory = RAM
  end

  config.vm.define :web do |web|
    web.vm.hostname = 'web' + DOMAIN
    web.vm.network :private_network, ip: NETWORK + "10", netmask: NETMASK

    config.vm.provision "ansible" do |ansible|
      ansible.host_key_checking = "false"
      ansible.playbook       = ANSIBLE_PLAYBOOK
      # Use a hand-crafted inventory
      #ansible.inventory_path = ANSIBLE_INVENTORY

      ansible.groups = {
        "firstGroup" => ["web"],
      }

    end
  end
end
